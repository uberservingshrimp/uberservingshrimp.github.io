<!DOCTYPE html>
<html>
  <head>
    <title>Is Uber Serving Shrimp Today?</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Is Uber Serving Shrimp Today?</p>

    <div id="yes" style="display: none;">
      <h1>YES</h1>
    </div>

    <div id="no" style="display: none;">
      <h1>NO</h1>
    </div>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script type="text/javascript">
      // Nothing to see here
      var CLIENT_ID = '501296072503-qe78naes3omd23fmm3g751rc38bol8lh.apps.googleusercontent.com';
      var API_KEY = 'AIzaSyDPim3bxeHw1Dg3eJf24xAHYsR0Kfb0FjM';
      var SPREADSHEET_ID = '1rzBahKazL5nPSXT32CZpgffkRoGcbodfzOa_Oh10wfo';

      // Array of API discovery doc URLs for APIs used
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

      var yesBlock = document.getElementById('yes');
      var noBlock = document.getElementById('no');

      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          var isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();

          updateSigninStatus(isSignedIn);
        }, function(error) {
          appendPre(JSON.stringify(error, null, 2));
        });
      }

      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          listMajors();
        } else {
          gapi.auth2.getAuthInstance().signIn().catch(responseErrorHandler);
        }
      }

      function appendPre(message) {
        var pre = document.getElementById('content');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      function getSheets() {
        var params = {
          spreadsheetId: SPREADSHEET_ID,
        };

        return gapi.client.sheets.spreadsheets.get(params);
      }

      function getValues(sheetTitle) {
        var params = {
          spreadsheetId: SPREADSHEET_ID,
          range: sheetTitle + '!1:4',
        };

        return gapi.client.sheets.spreadsheets.values.get(params);
      }

      function responseErrorHandler(response) {
        appendPre('Error: ' + response.result.error.message);
      }

      function getToday() {
        var today = new Date();
        return today.toLocaleDateString(undefined, {dateStyle: 'full'});
      }

      function listMajors() {
        getSheets().then(function(sheetsResponse) {
          var sheets = sheetsResponse.result.sheets;
          var firstSheet = sheets.filter(function(sheet) {
            return !sheet.properties.hidden;
          })[0];
          getValues(firstSheet.properties.title).then(function(valuesResponse) {
            var isShrimp = checkIfShrimp(valuesResponse.result.values);
            render(isShrimp);
          }, responseErrorHandler);
        }, responseErrorHandler);
      }

      function checkIfShrimp(values) {
        var dateStrings = values[0];
        var dishStrings = values[3];
        var today = getToday();
        var matchingIndex = dateStrings.findIndex(function(dateString) {
          return dateString === today;
        });

        if (matchingIndex === -1) {
          return false;
        }

        var dishString = dishStrings[matchingIndex];

        return /shrimp/i.test(dishString);
      }

      function render(isShrimp) {
        if (isShrimp) {
          yesBlock.style.display = 'block';
        } else {
          noBlock.style.display = 'block';
        }
      }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>
